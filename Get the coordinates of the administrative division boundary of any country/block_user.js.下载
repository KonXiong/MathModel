_.Module.define({path:"common/widget/blockUser",requires:["common/widget/detectManagerBlock"],sub:{template:'<div class="block_user_wrapper"> <ul class="b_u_items">   <li class="b_u_items_outer">  <label>\u5C01\u7981\u8D26\u6237</label><div class="b_username" ></div> </li>  <li class="b_u_items_outer">    <label>\u5C01\u7981\u65F6\u957F:</label>  <div class="b_block_time"> <span class="b_fixed_time">1\u5929</span>   <select class="b_select_time"> <option data-info="1">1\u5929</option> <option data-info="3">3\u5929</option><option data-info="10">10\u5929</option>  </select>  </div>   </li>  <li class="b_u_items_outer"> <label>\u5C01\u7981\u539F\u56E0:</label> <div class="b_reason_box"><ul class="b_reason_ul">   <li class="b_reason_item" data-prefix="1."></li><li class="b_reason_item" data-prefix="2."></li> <li class="b_reason_item" data-prefix="3."></li>  <li class="b_reason_item" data-prefix="4."></li>  <li class="b_reason_item" data-prefix="5."></li> <li class="b_reason_item" data-prefix="6."></li>  </ul><div class="b_reason_content">    <div class="b_reason_top">   <div class="b_top_mod_bar" > <div class="b_mod_bar"><span></span>\u4FEE\u6539</div>  <div class="b_del_bar"><span></span>\u5220\u9664</div>   </div><div class="b_top_save_bar">  <div class="b_save_bar"><span></span>\u4FDD\u5B58</div> <div class="b_cancel_bar"><span></span>\u53D6\u6D88</div></div>     </div>   <div class="b_reason_textarea">  <label for="b_user_textarea" class="b_label_tips">\u62B1\u6B49\uFF0C\u4F60\u7684\u53D1\u8D34\u64CD\u4F5C\u6216\u53D1\u8868\u8D34\u5B50\u7684\u5185\u5BB9\u8FDD\u53CD\u4E86\u672C\u5427\u7684\u5427\u89C4\uFF0C\u5DF2\u7ECF\u88AB\u5C01\u7981\uFF0C\u5C01\u7981\u671F\u95F4\u4E0D\u80FD\u5728\u672C\u5427\u7EE7\u7EED\u53D1\u8A00\u3002</label><textarea id="b_user_textarea" class="b_textarea"></textarea>      </div>    </div>   </div>   </li>   </ul>   <div class="block_btns">  <div class="block_tips"></div> <div class="b_id_btn">\u5C01\u7981ID</div> <div class="b_fixed_tips"></div>  </div> </div>',errTemplate:'<div class="block_response_info"></div> ',initial:function(e,a,t,i,n){var o=this,s=o.requireInstance("common/widget/detectManagerBlock",[]);s.doOnNotBlocked(function(){o._block(e,a,t,i,n)})},_block:function(e,a,t,i,n){this.config={block_reason_list:"/pmc/tpl",add_block_reason:"/pmc/tpl",modify_block_reason:"/pmc/tpl",del_block_reason:"/pmc/tpl",save_block_id:"/pmc/blockid"},this.blockList=$.extend(!0,[],e),this.power=a,this.forum=t,this.tbs=i,this.sucCallback=n,this.user_num=this.blockList.length,this.add_new_temp="<span>+</span>\u65B0\u5EFA\u6A21\u677F",this.textarea_maxlength=200,this.curr_pattern="";var o=window.PageData||{},s=o.power||{};this.isManager=(a.ban_id&&a.ban_ip||a.can_filter_id&&a.can_filter_ip)&&!s.can_type4_audit_post&&!s.can_type5_audit_post,this.isSmallManager=("undefined"==a.can_filter_id?!a.ban_id||!a.ban_ip:!a.can_filter_id||!a.can_filter_ip)||(a.ban_id&&a.ban_ip||a.can_filter_id&&a.can_filter_ip)&&s.can_type5_audit_post,this.$blockPopWinHtml=$(this.template),this.$responseBlockInfo=$(this.errTemplate),this.paramValidate(),this.setBlockDefaultInfo(),this.textareaKeyupEvtBind(),this.blockIDbtnEvtBind(),this.tabSwitchEvtBind(),this.textareaFocusEvtBind(),this.textareaBlurEvtBind(),this.logicalControl(),this.blockDialog.show(),this.trigger("show")},duplicateRemoval:function(e){for(var a={},t=[],i=e.length,n=0;i>n;n++)a[e[n]]||(t.push(e[n]),a[e[n]]=!0);return t},paramValidate:function(){var e=this;null===e.power.ban_id||null===e.power.ban_ip||""===e.power.ban_id||""===e.power.ban_ip?(this.blockDialog=new $.dialog({title:"\u5C01\u7981\u63D0\u793A",width:"556",html:this.$responseBlockInfo}),e.$responseBlockInfo.find(".block_response_info").html("\u4F60\u6CA1\u6709\u5C01\u7981\u64CD\u4F5C\u6743\u9650\uFF01")):e.blockDialog=new $.dialog({title:"\u5C01\u7981\u64CD\u4F5C",width:"556",html:this.$blockPopWinHtml}),e.blockDialog.bind("onclose",function(){e.user_num>1&&$.tb.location.reload()}),e.blockDialog.bind("onhide",function(){e.user_num>1&&$.tb.location.reload()})},insertDefaultNewTemp:function(){var e=this,a=0,t=0,i=!1;if($(".b_reason_ul .b_reason_item").each(function(e,i){$(i).hasClass("b_add_new_reason")||($(i).data("reasonId")&&""!=$(i).data("reasonId")&&$(i).data("isBuiltinTpl")===!1&&a++,t++)}),6>a){$(".b_reason_ul .b_reason_item").each(function(a,n){i&&$(".b_reason_ul .b_reason_item").eq(a).remove(),""!==$(n).html().trim()||i||($(n).tbattr("data-is-builtin-tpl",!1).tbattr("data-prefix",t),$(n).addClass("b_add_new_reason").append(e.add_new_temp),i=!0)});var n=$(".b_reason_ul .b_add_new_reason").length;0==n&&$(".b_reason_ul").append('<li class="b_reason_item b_add_new_reason" data-is-builtin-tpl="false" data-prefix="'+(t+1)+'.">'+e.add_new_temp+"</li>")}},setTextareaVal:function(){var e=this;0!=e.$blockPopWinHtml.find(".b_reason_curr").length||e.$blockPopWinHtml.find(".b_reason_item").eq(0).hasClass("b_add_new_reason")||e.$blockPopWinHtml.find(".b_reason_item").eq(0).addClass("b_reason_curr");var a=e.$blockPopWinHtml.find(".b_reason_curr");if(a.hasClass("b_add_new_reason"))e.$blockPopWinHtml.find(".b_textarea").val("");else if(a.html()){var t=a.html(),i=2;a.data("prefix")>=10&&(i=3),e.$blockPopWinHtml.find(".b_textarea").val(t.substr(i,t.length))}},noReasonCantModify:function(){var e=0,a=this;a.$blockPopWinHtml.find(".b_reason_item").each(function(a,t){"undefined"!=typeof $(t).tbattr("data-reason-id")&&e++}),0==e&&(a.$blockPopWinHtml.find(".b_add_new_reason").removeClass("b_reason_curr"),a.$blockPopWinHtml.find(".b_reason_top").hide(),""==a.$blockPopWinHtml.find(".b_textarea").val()&&a.$blockPopWinHtml.find(".b_label_tips").show())},setBlockReasonList:function(){var e=this,a=!1;$.ajax({url:e.config.block_reason_list,type:"POST",dataType:"json",data:{fid:e.forum.forum_id,tbs:e.tbs},success:function(t){if("0"==t.errno){var i=t.data;if(0==i.length)e.$blockPopWinHtml.find(".b_label_tips").show(),e.$blockPopWinHtml.find(".b_textarea").val(""),e.noReasonCantModify(),e.$blockPopWinHtml.find(".b_reason_item").each(function(e,a){$(a).removeAttr("data-reason-id").html("")}),e.$blockPopWinHtml.find(".b_reason_item").removeClass("b_reason_curr");else{var n=e.$blockPopWinHtml.find(".b_reason_item").length,o=i.length,s=o-n;if(s>0){for(var l=n,r="";s>0;)r+='<li class="b_reason_item" data-prefix="'+(l+1)+'." ></li>',l++,s--;$(".b_reason_ul").append(r)}e.$blockPopWinHtml.find(".b_reason_item").each(function(t,n){0==t&&(e.curr_pattern="undefined"!=typeof i[t]?"modify":"add"),"undefined"!=typeof i[t]?$(n).html(t+1+"."+i[t].template_text).tbattr("data-reason-id",i[t].template_id).tbattr("data-is-builtin-tpl",i[t].is_builtin_tpl).tbattr("data-prefix",t+1):$(n).html(""),$(n).hasClass("b_add_new_reason")&&!a&&($(n).removeClass("b_add_new_reason"),a=!0)}),e.$blockPopWinHtml.find(".b_reason_item").each(function(a,t){""==$(t).html()&&e.$blockPopWinHtml.find(".b_reason_item").eq(a).remove(),$(t).hasClass("b_reason_curr")&&($(t).data("isBuiltinTpl")?$(".b_top_mod_bar .b_del_bar").hide():$(".b_top_mod_bar .b_del_bar").show())})}e.isManager&&e.insertDefaultNewTemp(),e.setTextareaVal()}else e.setResponseTips(2,"\u83B7\u53D6\u5C01\u7981\u539F\u56E0\u5217\u8868\u5931\u8D25!")},error:function(a){e.setNewDialogRespTips(2,a)}})},setBlockDefaultInfo:function(){for(var e=this,a=[],t=[],i=0;i<e.blockList.length;++i){var n=e.blockList[i].nickname,o=e.blockList[i].username,s=[n,o].join("|");-1===$.inArray(s,t)&&a.push(n?n:o)}a=a.join(),e.$blockPopWinHtml.find(".b_username").html(a),e.setBlockReasonList()},textareaKeyupEvtBind:function(){var e=this;e.$blockPopWinHtml.find(".b_textarea").on("keyup",function(){var a=$(this).val(),t=$.tb.getByteLength(a),i=e.$blockPopWinHtml.find(".block_tips");i.css({display:"block"}),e.textarea_maxlength-t>0?($(this).hasClass("input_right_pattern")||$(this).addClass("input_right_pattern"),$(this).removeClass("input_error_pattern"),i.html("\u8FD8\u53EF\u8F93\u5165"+parseInt((e.textarea_maxlength-t)/2)+"\u5B57").addClass("b_green")):($(this).hasClass("input_error_pattern")||$(this).addClass("input_error_pattern"),$(this).removeClass("input_right_pattern"),i.removeClass("b_green").addClass("b_red").html("\u5DF2\u8D85\u51FA"+parseInt(parseInt((t-e.textarea_maxlength)/2)+1)+"\u5B57"))})},textareaFocusEvtBind:function(){var e=this;e.$blockPopWinHtml.on("focus.showEditor",".b_textarea",function(){e.curr_pattern="add",e.toogleToolBar(),e.$blockPopWinHtml.find(".block_tips").html("").removeClass("b_red,b_green"),e.$blockPopWinHtml.find(".b_label_tips").css({display:"none"}),e.isManager?e.$blockPopWinHtml.find(".b_reason_top").show():e.$blockPopWinHtml.find(".b_reason_top").hide()})},textareaBlurEvtBind:function(){var e=this;e.$blockPopWinHtml.on("click",function(a){var t=$(a.target);if(0==t.closest(".b_reason_box").length){e.curr_pattern="modify",e.toogleToolBar(),0==e.$blockPopWinHtml.find(".b_reason_curr").length&&e.$blockPopWinHtml.find(".b_reason_top").hide();var i=e.isSmallManager;i&&(""==e.$blockPopWinHtml.find(".b_textarea").val()?e.$blockPopWinHtml.find(".b_label_tips").show():e.$blockPopWinHtml.find(".b_label_tips").hide()),e.$blockPopWinHtml.find(".block_tips").html(""),e.noReasonCantModify()}})},modifyTextareaCon:function(){var e=this;e.$blockPopWinHtml.find(".b_mod_bar").on("click",function(){e.$blockPopWinHtml.find(".b_textarea").trigger("focus")})},deleteTextareaCon:function(){var e=this;e.$blockPopWinHtml.find(".b_del_bar").on("click",function(){if("undefined"==typeof e.$blockPopWinHtml.find(".b_reason_curr").tbattr("data-reason-id")||e.$blockPopWinHtml.find(".b_reason_curr").hasClass("b_add_new_reason")||e.$blockPopWinHtml.find(".b_reason_curr").data("isBuiltinTpl"))return!1;var a={op:"del",id:e.$blockPopWinHtml.find(".b_reason_curr").tbattr("data-reason-id"),fid:e.forum.forum_id,tbs:e.tbs};$.ajax({url:e.config.del_block_reason,type:"POST",dataType:"json",data:a,success:function(a){"0"==a.errno?(e.$blockPopWinHtml.find(".b_reason_curr").removeAttr("data-reason-id"),e.setBlockReasonList(),e.setResponseTips(1,"\u5220\u9664\u6210\u529F\uFF01")):e.setResponseTips(2,"\u5220\u9664\u5931\u8D25!")},error:function(a){e.setNewDialogRespTips(2,a)}})})},toogleToolBar:function(){var e=this;e.isManager?(e.$blockPopWinHtml.find(".b_reason_top").css({display:"block"}),"modify"==this.curr_pattern?(e.$blockPopWinHtml.find(".b_top_mod_bar").css({display:"block"}),e.$blockPopWinHtml.find(".b_top_save_bar").css({display:"none"})):"add"==this.curr_pattern&&(e.$blockPopWinHtml.find(".b_top_mod_bar").css({display:"none"}),e.$blockPopWinHtml.find(".b_top_save_bar").css({display:"block"}))):e.$blockPopWinHtml.find(".b_reason_top").css({display:"none"})},saveTextareaCon:function(){var e,a=this,t={},i=a.$blockPopWinHtml.find(".b_textarea");a.$blockPopWinHtml.find(".b_save_bar").on("click",function(){if(!a.checkCanbeBlocked())return!1;var n=a.$blockPopWinHtml.find(".b_reason_curr").hasClass("b_add_new_reason")||0==a.$blockPopWinHtml.find(".b_reason_curr").length;n?(t={op:"add",tbs:a.tbs,fid:a.forum.forum_id,ie:"gbk",text:$.tb.escapeHTML(i.val())},e=a.config.add_block_reason):(t={op:"update",tbs:a.tbs,fid:a.forum.forum_id,ie:"gbk",text:$.tb.escapeHTML(a.$blockPopWinHtml.find(".b_textarea").val()),id:a.$blockPopWinHtml.find(".b_reason_curr").tbattr("data-reason-id")},e=a.config.modify_block_reason),$.ajax({url:e,type:"POST",dataType:"json",data:t,success:function(e){a.curr_pattern="modify",a.toogleToolBar(),"0"==e.errno?(a.setBlockReasonList(),a.setResponseTips(1,"\u4FDD\u5B58\u6210\u529F\uFF01"),n?$.stats.track("AddReasonItem","uegCount","bawuAppeal","success"):$.stats.track("modifyReasonItem"+$(".b_reason_curr").index(),"uegCount","bawuAppeal","success")):a.setResponseTips(2,"\u4FDD\u5B58\u5931\u8D25!")},error:function(e){a.setNewDialogRespTips(2,e)}})})},cancelTextareaCon:function(){var e=this;e.$blockPopWinHtml.find(".b_cancel_bar").on("click",function(){e.setTextareaVal(),e.curr_pattern="modify",e.toogleToolBar(),e.$blockPopWinHtml.find(".b_reason_curr").hasClass("b_add_new_reason")&&e.$blockPopWinHtml.find(".b_reason_item").siblings().removeClass("b_reason_curr").end().eq(0).addClass("b_reason_curr")})},getSavesData:function(e){var a=this,t={};t.day="block"===a.$blockPopWinHtml.find(".b_fixed_time").css("display")?"1":a.$blockPopWinHtml.find(".b_select_time").find("option:selected").tbattr("data-info"),t.fid=a.forum.forum_id,t.tbs=a.tbs,t.ie="gbk",t.user_name=[],t.nick_name=[],t.pid=[],t.portrait=[];for(var i=0;i<a.blockList.length;++i){var n=a.blockList[i];n.portrait?-1===$.inArray(n.portrait,t.portrait)&&(t.user_name.push($.tb.escapeHTML(n.username)),t.nick_name.push($.tb.escapeHTML(n.nickname||"")),t.portrait.push(n.portrait),n.pid&&t.pid.push(n.pid)):(-1===$.inArray(n.username,t.user_name)&&t.user_name.push(n.username),n.pid&&t.pid.push(n.pid))}var o=a.$blockPopWinHtml.find(".b_textarea"),s=0;return a.$blockPopWinHtml.find(".b_reason_item").each(function(e,a){"undefined"==typeof $(a).tbattr("data-reason-id")&&s++}),t.reason=6==s&&""===o.val().trim()?a.$blockPopWinHtml.find(".b_label_tips").html():a.$blockPopWinHtml.find(".b_textarea").val(),t.reason=$.tb.escapeHTML(t.reason),2===e&&(t.ip="1"),t},checkCanbeBlocked:function(){var e=this,a=e.$blockPopWinHtml.find(".b_textarea"),t=0;return a.hasClass("input_error_pattern")||""===a.val().trim()?(e.$blockPopWinHtml.find(".b_reason_item").each(function(e,a){"undefined"==typeof $(a).tbattr("data-reason-id")&&t++}),6==t?!0:(e.$blockPopWinHtml.find(".b_textarea").trigger("focus"),a.hasClass("input_error_pattern")?e.setResponseTips(2,"\u5C01\u7981\u539F\u56E0\u4E0D\u80FD\u8D85\u51FA100\u5B57"):e.setResponseTips(2,"\u5C01\u7981\u539F\u56E0\u4E0D\u80FD\u4E3A\u7A7A"),!1)):!0},blockIDbtnEvtBind:function(){var e=this;e.$blockPopWinHtml.find(".b_id_btn").on("click",function(){if(!e.checkCanbeBlocked())return!1;var a=e.getSavesData(1),t=function(i){a=i?$.extend(a,i):a,$.ajax({url:e.config.save_block_id,type:"POST",dataType:"json",data:a,success:function(a){if(1990055===a.errno)if("undefined"==typeof passport||"undefined"==typeof passport.pop.init){var i="undefined"!=typeof Env&&Env.server_time?Env.server_time:(new Date).getTime(),n="https://passport";$.JsLoadManager.use([n+".baidu.com/passApi/js/uni_login_wrapper.js?cdnversion="+Math.floor(i/6e4),n+".baidu.com/passApi/js/wrapper.js?cdnversion="+Math.floor(i/6e4)],function(){window.realname=passport.pop.init({type:"accRealName",apiOpt:{product:"tb",staticPage:"//tieba.baidu.com/tb/static-common/html/pass/v3Jump.html"},tangram:!0,color:"green"}),window.realname.show()},!0,"utf-8")}else window.realname.show();else"0"==a.errno?(e.setNewDialogRespTips(1,"\u5C01\u7981\u6210\u529F\uFF01"),(e.sucCallback||"function"==typeof e.sucCallback)&&e.sucCallback()):224011==a.errno?e.getCaptcha(a,t,e):e.setNewDialogRespTips(2,a.errmsg||"\u5C01\u7981\u5931\u8D25\uFF01")},error:function(a){e.setNewDialogRespTips(2,a)}})};t()})},getCaptcha:function(e,a,t){var i=this;t=t||i;var n=PageData.forum_name||(PageData.forum?PageData.forum.forum_name:""),o=PageData.forum_id||(PageData.forum?PageData.forum.forum_id:"");this.requireInstanceAsync("common/component/CaptchaDialog",[{title:"\u5C01\u7981",message:"\u5C01\u7981\u4E86\u90A3\u4E48\u591A\u4EBA\uFF0C\u8F93\u4E2A\u7801\u9A8C\u8BC1\u4E0B\u8EAB\u4EFD\u5427~",vCode:e.res.captcha_vcode_str,vCodeType:e.res.captcha_code_type,forumName:n,forumId:o,postType:"thread",paramsCallback:function(){return{}}}],function(e){i.captchaDialog=e,e.bind("onclose",function(){return e.hide(),!1}),e.bind("onaccept",function(){var i={vcode:e.getInputValue(),vcode_md5:e.getVCode()};a.call(t,i)}),e.show()})},setResponseTips:function(e,a){var t=this,i=t.$blockPopWinHtml.find(".block_tips");1==e?i.removeClass("b_red").addClass("b_green").html(a):i.removeClass("b_green").addClass("b_red").html(a),window.setTimeout(function(){i.hasClass("b_green")&&i.html("")},2e3)},setNewDialogRespTips:function(e,a){var t=this,i=t.$blockPopWinHtml;i.html(t.$responseBlockInfo),1==e?i.find(".block_response_info").removeClass("b_red").addClass("b_green").html(a):i.find(".block_response_info").removeClass("b_green").addClass("b_red").html(a),window.setTimeout(function(){t.blockDialog.hide(),t.user_num>1&&$.tb.location.reload(),t.trigger("hide")},2e3)},tabSwitchEvtBind:function(){var e=this;e.$blockPopWinHtml.on("click",".b_reason_item",function(){return $(this).data("isBuiltinTpl")?$(".b_top_mod_bar .b_del_bar").hide():$(".b_top_mod_bar .b_del_bar").show(),"undefined"!=typeof $(this).tbattr("data-reason-id")||$(this).hasClass("b_add_new_reason")?("none"==e.$blockPopWinHtml.find(".b_reason_top").css("display")&&e.$blockPopWinHtml.find(".b_reason_top").css({display:"block"}),$(this).siblings(".b_reason_item").removeClass("b_reason_curr").end().addClass("b_reason_curr"),$(this).hasClass("b_add_new_reason")?(e.curr_pattern="add",e.$blockPopWinHtml.find(".b_textarea").trigger("focus")):(e.curr_pattern="modify",$.stats.track("reasonItem"+$(this).index(),"uegCount","bawuAppeal","click")),e.$blockPopWinHtml.find(".b_label_tips").hide(),e.setTextareaVal(),void e.toogleToolBar()):!1})},logicalControl:function(){var e=this,a=e.$blockPopWinHtml.find(".b_fixed_time"),t=e.$blockPopWinHtml.find(".b_select_time");if(e.$blockPopWinHtml.find(".b_reason_item").eq(0).addClass("b_reason_curr"),e.isManager){var i="\u63D0\u793A\uFF1A\u5927\u5427\u4E3B\u53EF\u7F16\u8F91\u539F\u56E0\u6A21\u7248\uFF0C\u4FDD\u5B58\u540E\u5C0F\u5427\u4E3B\u53EF\u76F4\u63A5\u4F7F\u7528\u6587\u6848~";e.forum.isPrivateForum&&(i="\u63D0\u793A\uFF1A\u5427\u4E3B\u53EF\u7F16\u8F91\u539F\u56E0\u6A21\u677F\uFF0C\u6A21\u677F\u4FDD\u5B58\u540E\u7BA1\u7406\u5427\u52A1\u53EF\u4EE5\u76F4\u63A5\u4F7F\u7528\u6A21\u677F\u7684\u6587\u6848~"),e.$blockPopWinHtml.find(".b_fixed_tips").html(i),e.user_num>1?(a.css({display:"block"}),t.css({display:"none"})):1==e.user_num&&(a.css({display:"none"}),t.css({display:"block"})),e.$blockPopWinHtml.find(".b_reason_top,.b_top_mod_bar").css({display:"block"}),e.modifyTextareaCon(),e.deleteTextareaCon(),e.saveTextareaCon(),e.cancelTextareaCon()}else{var n="\u63D0\u793A\uFF1A\u539F\u56E0\u6A21\u7248\u53EA\u6709\u5927\u5427\u4E3B\u53EF\u4EE5\u7F16\u8F91\uFF0C\u5C0F\u5427\u4E3B\u4E5F\u53EF\u76F4\u63A5\u5728\u8F93\u5165\u6846\u4E2D\u5199\u4E0A\u5185\u5BB9\u5E76\u5B8C\u6210\u5C01\u7981~";e.forum.isPrivateForum&&(n="\u63D0\u793A\uFF1A\u7BA1\u7406\u5427\u52A1\u53EF\u4EE5\u4F7F\u7528\u5427\u4E3B\u7F16\u8F91\u7684\u539F\u56E0\u6A21\u677F\uFF0C\u6216\u8005\u81EA\u5DF1\u5728\u8F93\u5165\u6846\u586B\u5199\u5185\u5BB9\u5B8C\u6210\u5C01\u7981~"),e.$blockPopWinHtml.find(".b_fixed_tips").html(n),a.css({display:"block"}),t.css({display:"none"})}}}});